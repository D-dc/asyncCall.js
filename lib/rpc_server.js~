//
// RPC library, server side.
// 

var Server = require('socket.io'),
    ServerSingleSocket = require('./rpc.js'),
    port = process.env.PORT || 80;


//see server options
//https://github.com/Automattic/engine.io/blob/master/lib/server.js#L38
var defaultOptions = function() {
    return {
        //heartbeat
        pingTimeout: 6000, //timeout from client to receive new heartbeat from server (value shipped to client)
        pingInterval: 2500, //timeout when server should send heartbeat to client
        defaultReplyTimeOut: Infinity   //default delay before an RPC call should have its reply. Infinity = no timeout
    };
}

var ServerRpc = function(serverHttp, opts) {
    this.options = opts || defaultOptions();
    this.io = new Server(serverHttp, this.options);
    this.connectedClients = [];
    this.exposedFunctions;
    var that = this;

    this.io.on('connection', function(socket) {
        var s = new ServerSingleSocket(socket, that.options);
        s.expose(that.exposedFunctions);
        that.connectedClients.push(s);
        console.log('open connections', that.connectedClients.length);

        socket.on('init', function(data){
            var clientId = s._genId('client');
            this.remoteClientId=clientId;
            socket.emit('init1', {'clientId':clientId})
        })
    });
}

ServerRpc.prototype.expose = function(o) {
    this.exposedFunctions = o;
}

ServerRpc.prototype.rpcCall = function(name, args, cb) {
    for (var c in this.connectedClients){
        this.connectedClients[c].rpcCall(name, args, cb);
    }
}

module.exports = ServerRpc;

////////////////////////////////////////////////////////////////////////////////////////////


var express = require('express'),
    app = express(),
    serverHttp = require('http').createServer(app);

serverHttp.listen(port, function() {
    console.log('Server listening at port %d', port);
});
app.use("/", express.static(__dirname + '/public'));

var c=1;
var myServer = new ServerRpc(serverHttp);
myServer.expose({
     'testRemote': function(a, b) {
         //excess arguments are accessible via 'arguments'
         var args = Array.prototype.slice.call(arguments);
         console.log("testRemote called, args: " + args);
         c++
         return a + b + c;
     },
     'pong': function(b) {
         b = b + 1;
         console.log("pong " + b);
         setTimeout(function() {
             myServer.rpcCall("ping", [b])
         }, 2000);
     },
     'slow': function() {
        //pausecomp(10000);
     }
 });



